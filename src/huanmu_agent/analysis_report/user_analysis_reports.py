from langchain_core.messages import AnyMessage, BaseMessage, AIMessage,HumanMessage
from langgraph.graph import StateGraph, START, END
from langgraph.prebuilt import create_react_agent
from langgraph.prebuilt.chat_agent_executor import AgentState
from langchain.chat_models import init_chat_model
from langchain_community.chat_models.tongyi import ChatTongyi
from langchain_core.runnables import RunnableConfig
from typing_extensions import TypedDict
from typing import List, Optional, Dict, Any
from pydantic import BaseModel, Field
import asyncio

from constant import GOOGLE_GEMINI_FLASH_MODEL
class UserChunkSummaryResponse(BaseModel):
    user_chunk_summary: Optional[str] = Field(description="ç”¨æˆ·æƒ…å†µæ€»ç»“")
    error_message: Optional[str] = Field(default=None, description="å‡ºé”™æ—¶çš„é”™è¯¯ä¿¡æ¯")

class AiDialogStyleResponse(BaseModel):
    ai_dialog_style: Optional[str] = Field(description="AIå¯¹è¯é£æ ¼æè¿°")
    error_message: Optional[str] = Field(default=None, description="å‡ºé”™æ—¶çš„é”™è¯¯ä¿¡æ¯")

class RecommendationResponse(BaseModel):
    recommendation: Optional[str] = Field(description="é’ˆå¯¹ç”¨æˆ·çš„æœåŠ¡å»ºè®®æˆ–æ¨è")
    error_message: Optional[str] = Field(default=None, description="å‡ºé”™æ—¶çš„é”™è¯¯ä¿¡æ¯")

class UserSummaryAgentState(AgentState):
    structured_response: Optional[UserChunkSummaryResponse]
    error_message: Optional[str]

class AiStyleAgentState(AgentState):
    structured_response: Optional[AiDialogStyleResponse]
    error_message: Optional[str]

class RecommendationAgentState(AgentState):
    structured_response: Optional[RecommendationResponse]
    error_message: Optional[str]

class UserAnalysisAgentState(AgentState):
    structured_response: Optional[str]
    error_message: Optional[str]

class ChatReplyAgentStateInput(TypedDict):
    messages: List[BaseMessage]


# llm = init_chat_model(model="gpt-4o", temperature=0.7, model_provider="openai")
llm = init_chat_model(
    model=GOOGLE_GEMINI_FLASH_MODEL,
    model_provider="google_vertexai",
    temperature=0.7,  # Balanced creativity
)
def prompt_recommendation(state: AgentState) -> List[AnyMessage]:
    system_msg = f"""
ä½ æ˜¯ä¸€åèµ„æ·±åŒ»ç¾é¡¾é—®ï¼Œä»¥ä¸‹æ˜¯åŒ»ç¾AIå®¢æœä¸ç”¨æˆ·çš„å®Œæ•´å¤šè½®å¯¹è¯å†…å®¹ï¼š{state["messages"]}

è¯·ä½ åŸºäºè¯¥å¯¹è¯å†…å®¹ï¼Œæ’°å†™ä¸€ä»½ä¸“ä¸šã€ç»“æ„åŒ–çš„åŒ»ç¾å®¢æˆ·é£é™©é¢„è­¦ä¸ä¸ªæ€§åŒ–æœåŠ¡å»ºè®®ã€‚è¯¥æŠ¥å‘Šå°†ç”¨äºé—¨åº—æ¥å¾…å‰ä¼šè®®æˆ–CRMç³»ç»Ÿå½•å…¥ï¼Œéœ€å†…å®¹è¯¦å®ã€åˆ†ç±»æ¸…æ™°ã€å…·å¤‡æ‰§è¡Œå‚è€ƒä»·å€¼ï¼Œè¦†ç›–ä»¥ä¸‹å…­å¤§æ ¸å¿ƒæ¨¡å—ï¼š
ğŸ“Œ æ—¶é—´çº¿åˆ†æè¦æ±‚ï¼š(å¦‚æœæœ‰å¯¹è¯æ—¶é—´æˆ–è€…ç”¨æˆ·æåˆ°çš„æ—¶é—´ï¼‰
- è¯·ç»“åˆå¯¹è¯æ—¶é—´ï¼Œè¯„ä¼°ä¿¡æ¯çš„â€œæ–°é²œåº¦â€ï¼Œå¯¹ç”¨æˆ·æœ€è¿‘è¡¨è¾¾çš„ä¿¡æ¯ç»™äºˆæ›´é«˜æƒé‡ï¼›
- è‹¥å®¢æˆ·é•¿æ—¶é—´æœªå›å¤ã€è¡¨è¾¾çŠ¹è±«ã€ä¿¡æ¯ä¸­æ–­ï¼Œè¯·ç‰¹åˆ«æ ‡æ³¨â€œæ½œåœ¨æµå¤±é¢„è­¦â€ï¼›
- è‹¥å¯¹æ—¶é—´ç‚¹è¡¨è¾¾ä¸æ˜ï¼Œè¯·ä½¿ç”¨æ‹¬å·æ ‡æ³¨â€œéœ€ç¡®è®¤â€ã€‚

ğŸ“Œ è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
- æŠ¥å‘Šéœ€æŒ‰ç…§ä»¥ä¸Šå…­ä¸ªéƒ¨åˆ†åˆ†ç« èŠ‚å‘ˆç°ï¼›
- å„éƒ¨åˆ†å»ºè®®åº”å…·ä½“ã€å…·æ‰§è¡Œæ€§ï¼Œé¿å…æ³›æ³›è€Œè°ˆï¼›
- ä¸å¾—é—æ¼æ¨¡å—ï¼›å¦‚ä¿¡æ¯ä¸è¶³ï¼Œå¯æ³¨æ˜â€œæš‚æ— æ˜ç¡®ä¿¡æ¯â€æˆ–â€œæš‚æ— æ³•åˆ¤æ–­â€ã€‚
- æœ¬æ¬¡è¾“å‡ºæœ‰ä¸”åªéœ€è¦"åŒ»ç¾å®¢æˆ·é£é™©é¢„è­¦ä¸ä¸ªæ€§åŒ–æœåŠ¡å»ºè®®"éƒ¨åˆ†ï¼Œè¯·å‹¿å°†å…¶ä»–å†…å®¹æ”¾è¿›æ¥ï¼Œä¸”ä¸è¦æ”¾é‡å¤å†…å®¹ã€‚

è¯·ç”¨æ­£å¼ã€ä¸“ä¸šã€ä¸­æ–‡æŠ¥å‘Šé£æ ¼æ’°å†™ã€‚
---------------------------------------------------------------------------------------------------------
ä¸€ã€åŒ»ç¾å®¢æˆ·é£é™©é¢„è­¦ä¸ä¸ªæ€§åŒ–æœåŠ¡å»ºè®®
ã€1ã€å®¢æˆ·é˜¶æ®µåˆ¤æ–­ã€‘ï¼ˆå®åœ¨æ— æ³•åˆ¤æ–­å†™æš‚æ— æ³•åˆ¤æ–­ï¼‰
- è¯·æ ¹æ®å¯¹è¯å†…å®¹åŠæ—¶é—´åˆ†å¸ƒï¼Œåˆ¤æ–­è¯¥å®¢æˆ·å¤„äºä»¥ä¸‹å“ªä¸€é˜¶æ®µï¼Œå¹¶ç®€è¦è¯´æ˜åˆ¤æ–­ä¾æ®ï¼š
æ½œåœ¨å®¢æˆ·æœŸ:å°šæœªæ˜ç¡®è¡¨è¾¾å…´è¶£ï¼Œä»…åœç•™åœ¨åˆæ­¥æµè§ˆæˆ–æ³›æ³›æé—®é˜¶æ®µï¼Œç¼ºä¹å…·ä½“é¡¹ç›®æˆ–æ—¶é—´è®¡åˆ’ã€‚
å…´è¶£å®¢æˆ·æœŸ:å¯¹æŸç±»é¡¹ç›®æœ‰æ˜ç¡®å…³æ³¨æˆ–å¤šè½®æé—®ï¼Œä½†ä»æœªè¡¨æ˜ä»·æ ¼æ¥å—åº¦ã€æ—¶é—´å®‰æ’æˆ–åŒ»ç”Ÿåå¥½ã€‚
æ„å‘å®¢æˆ·æœŸ:æ˜ç¡®è¡¨è¾¾éœ€æ±‚ + æŒ‡å®šæ—¶é—´/åŒ»ç”Ÿ/é£æ ¼å€¾å‘ + å¯¹ä»·æ ¼/æ´»åŠ¨æ•æ„Ÿï¼Œæ¥è¿‘é¢„çº¦/ä»˜æ¬¾ã€‚
æˆäº¤å®¢æˆ·æœŸ:å·²é¢„çº¦æˆ–å·²æ”¯ä»˜ï¼Œæœ‰æ˜ç¡®æ‰‹æœ¯å®‰æ’æˆ–ä½“éªŒè®¡åˆ’ã€‚
å¿ è¯šå®¢æˆ·æœŸ:é¡¹ç›®åä»ä¿æŒè”ç³»ã€åé¦ˆç§¯æã€æ„¿æ„è½¬ä»‹ç»æˆ–å¤è´­ï¼Œæœ‰KOCæ½œåŠ›ã€‚
æµå¤±æ¢å›æœŸ:é•¿æ—¶é—´æœªè”ç³» / æ˜ç¡®è¡¨è¾¾çŠ¹è±«ã€åæ‚” / å’¨è¯¢é¢‘ç‡æ˜¾è‘—ä¸‹é™ï¼Œéœ€é‡æ–°æ¿€æ´»ã€‚
eg.
- å½“å‰é˜¶æ®µåˆ¤æ–­ï¼šæ„å‘å®¢æˆ·æœŸ
- åˆ¤æ–­ä¾æ®ï¼šç”¨æˆ·å¤šæ¬¡è¯¢é—®â€œé¼»ç»¼åˆä»·æ ¼â€å’Œâ€œæ¢å¤æœŸâ€ï¼Œè¡¨è¾¾äº†å¯¹åˆ˜ä¸»ä»»é£æ ¼çš„åå¥½ï¼Œå¹¶è®¡åˆ’â€œ7æœˆåˆå®‰æ’æ‰‹æœ¯â€ï¼ˆæ—¶é—´è¿‘ï¼Œæ„å›¾æ˜ç¡®ï¼‰ã€‚

ã€2ã€å®¢æˆ·æµå¤±é£é™©é¢„è­¦ã€‘ï¼ˆå®åœ¨æ— æ³•åˆ¤æ–­å†™æš‚æ— æ³•åˆ¤æ–­ï¼‰
- åˆ†æå®¢æˆ·æ˜¯å¦å­˜åœ¨æµå¤±é£é™©ï¼Œè¯†åˆ«å…³é”®è¡¨ç°ï¼ˆå¦‚æ²Ÿé€šé¢‘æ¬¡ä¸‹é™ã€è´Ÿé¢æƒ…ç»ªè¡¨è¾¾å¢åŠ ã€å’¨è¯¢åé•¿æœŸæœªå›åº”ç­‰ï¼‰ï¼›
- åˆ¤æ–­é£é™©ç­‰çº§ï¼ˆä½ / ä¸­ / é«˜ï¼‰ï¼Œå¹¶è¯´æ˜ä¾æ®ï¼›
- é’ˆå¯¹ä¸åŒé£é™©ç­‰çº§ï¼Œæå‡ºå…·ä½“åº”å¯¹ç­–ç•¥ï¼Œå¦‚ä¸€å¯¹ä¸€ä¸“å±è·Ÿè¿›ã€æ¿€æ´»ä¼˜æƒ ã€æƒ…æ„Ÿå…³æ€€ç­‰ï¼›
- å¯ç»“åˆå®¢æˆ·ç‰¹å¾ï¼Œæå‡ºæµå¤±å¹²é¢„èŠ‚ç‚¹å»ºè®®ï¼Œä¾›åç»­ç³»ç»Ÿæ‰“æ ‡ç­¾æˆ–äººæ‰‹å®‰æ’ã€‚
eg.
æ˜¯å¦å­˜åœ¨æµå¤±é£é™©ï¼š æ˜¯
å…³é”®è¡¨ç°ï¼š ç”¨æˆ·å‰æœŸå’¨è¯¢é¢‘ç¹ï¼Œä½†åœ¨æåˆ°â€œä»·æ ¼æœ‰ç‚¹è´µâ€åï¼Œå·²è¶…è¿‡7å¤©æœªå›å¤å®¢æœè·Ÿè¿›ã€‚(2025å¹´6æœˆ20æ—¥ä¹‹åæœªå›å¤)
é£é™©ç­‰çº§åˆ¤æ–­ï¼š ä¸­é£é™©
åº”å¯¹ç­–ç•¥ï¼šæ¨é€é™æ—¶ä¼˜æƒ ï¼Œé™ä½å…¶ä»·æ ¼é¡¾è™‘ï¼›
å»ºè®®å®‰æ’é¡¾é—®ä¸€å¯¹ä¸€å›è®¿ï¼Œæä¾›åˆ†æœŸä»˜æ¬¾æ–¹æ¡ˆæˆ–ä½“éªŒæ´»åŠ¨ï¼›
æ§åˆ¶é¢‘ç‡ï¼Œé¿å…ç”¨æˆ·äº§ç”Ÿæ‰“æ‰°æ„Ÿã€‚
å¹²é¢„èŠ‚ç‚¹å»ºè®®ï¼š
ç¬¬7å¤©æ— å›å¤ â†’ è‡ªåŠ¨å‘é€æ¸©å’Œæé†’ï¼›
ç¬¬14å¤©æ— åŠ¨ä½œ â†’ è½¬äººå·¥ä»‹å…¥åˆ¤æ–­æ˜¯å¦å½»åº•æµå¤±ã€‚

ã€3ã€èˆ†æƒ…é£é™©ç›‘æ§ä¸åº”å¯¹ã€‘ï¼ˆå®åœ¨æ— æ³•åˆ¤æ–­å†™æš‚æ— æ³•åˆ¤æ–­ï¼‰
- åˆ¤æ–­å®¢æˆ·æ˜¯å¦å­˜åœ¨æ½œåœ¨çš„è´Ÿé¢ä¼ æ’­é£é™©ï¼ŒåŒ…æ‹¬å£ç¢‘ä¸æ»¡ã€ç¤¾äº¤æ´»è·ƒåº¦é«˜ä½†æƒ…ç»ªæ³¢åŠ¨ç­‰ï¼›
- å¦‚æœ‰æ˜æ˜¾èˆ†æƒ…é£é™©ï¼Œéœ€åŒºåˆ†â€œæ™®é€šè´Ÿé¢â€ä¸â€œé‡å¤§é£é™©â€ï¼Œå¹¶æå‡ºå¯¹åº”å¤„ç†æœºåˆ¶ï¼ˆå¦‚å®¢æœä¸»ç®¡ä»‹å…¥ã€å…¬å…³å›¢é˜Ÿä»‹å…¥ç­‰ï¼‰ï¼›
- åŒæ—¶å»ºè®®å¯å‘å¸ƒçš„æ­£é¢å†…å®¹ï¼ˆå¦‚å®¢æˆ·æˆåŠŸæ¡ˆä¾‹ã€æœåŠ¡æ‰¿è¯ºç­‰ï¼‰ä»¥ä¸»åŠ¨ç»´æŠ¤å“ç‰Œå£°èª‰ã€‚
eg.
æ˜¯å¦å­˜åœ¨èˆ†æƒ…é£é™©ï¼š æœ‰
å…³é”®è¡¨ç°ï¼š ç”¨æˆ·åœ¨æ²Ÿé€šä¸­å¤šæ¬¡æåŠâ€œæœ‹å‹åšäº†æ„Ÿè§‰å¾ˆç³Ÿç³•â€ã€â€œç½‘ä¸Šå¾ˆå¤šäººè¯´æ¢å¤æœŸå¾ˆä¹…â€ï¼ŒåŒæ—¶æœ¬äººåœ¨å°çº¢ä¹¦æœ‰å‘å¸–ä¹ æƒ¯ï¼Œç²‰ä¸çº¦3000äººã€‚
é£é™©ç­‰çº§åˆ¤æ–­ï¼š æ™®é€šè´Ÿé¢
åº”å¯¹ç­–ç•¥ï¼šå»ºè®®ç”±å®¢æœä¸»ç®¡è¿›è¡Œæƒ…ç»ªå®‰æŠšï¼Œä¸»åŠ¨æä¾›åŒ»ç”Ÿæ¡ˆä¾‹å›¾ä¸æœ¯åæ¢å¤æµç¨‹è¯´æ˜ï¼Œå¢å¼ºä¿¡ä»»ï¼›æä¾›å®‰å¿ƒä¿éšœå†…å®¹ï¼ˆå¦‚â€œ7å¤©å†…æ¢å¤æ‰¿è¯ºâ€â€œä¸æ»¡æ„å¯å…è´¹ä¿®å¤â€æ”¿ç­–ï¼‰ã€‚
æ­£é¢å†…å®¹å»ºè®®ï¼šæ¨é€ä¸å…¶å…³æ³¨é¡¹ç›®ç›¸å…³çš„çœŸå®å®¢æˆ·å¥½è¯„ä¸æœ¯å‰æœ¯åå¯¹æ¯”å›¾ï¼Œå¼ºåŒ–æ­£é¢å°è±¡ï¼›
é€‚å½“æ¨èé—¨åº—å£ç¢‘åŒ»ç”Ÿï¼Œé™ä½å…¶é¡¾è™‘ã€‚

ã€4ã€è´­ä¹°æ„å›¾è¯†åˆ«ä¸ç²¾å‡†å¼•å¯¼ã€‘ï¼ˆæ²¡æœ‰çš„å†™æš‚æ— æ³•åˆ¤æ–­ï¼‰
- åˆ†æå®¢æˆ·å½“å‰çš„è´­ä¹°æ„å‘å¼ºåº¦ï¼ˆé«˜ / ä¸­ / ä½ / æš‚ä¸æ˜ç¡®ï¼‰ï¼Œç»“åˆå…¶æé—®å†…å®¹ã€æƒ…ç»ªçŠ¶æ€ã€è¡¨è¾¾æ„æ„¿è¿›è¡Œåˆ¤æ–­ï¼›
- å¯¹äºé«˜æ„å›¾å®¢æˆ·ï¼Œå»ºè®®æ¨è¿›æ–¹å¼ï¼ˆå¦‚ä¸“å±ä¼˜æƒ ã€æ˜ç¡®ä»˜æ¬¾æµç¨‹ã€å¼ºè°ƒæ¡ˆä¾‹æˆåŠŸï¼‰ï¼›
- å¯¹äºä½æ„å›¾å®¢æˆ·ï¼Œå»ºè®®é€šè¿‡å»ºç«‹ä¿¡ä»»ã€ä»·å€¼å…±é¸£ç­‰æ–¹å¼è¿›è¡Œå…³ç³»ç»´ç³»ï¼Œé¿å…å¼ºæ¨ï¼›
- æ˜ç¡®æ˜¯å¦æ¨èåœ¨çŸ­æœŸå†…å‘èµ·è¥é”€è§¦è¾¾ã€‚
eg.
è´­ä¹°æ„å‘å¼ºåº¦ï¼š é«˜
åˆ¤æ–­ä¾æ®ï¼š å®¢æˆ·å¤šæ¬¡ä¸»åŠ¨è¯¢é—®æœ¯åæ¢å¤æ—¶é—´åŠä»˜æ¬¾æ–¹å¼ï¼Œè¡¨è¾¾å¸Œæœ›å°½å¿«é¢„çº¦çš„æ„æ„¿ã€‚
æ¨è¿›å»ºè®®ï¼šæä¾›ä¸“å±ä¼˜æƒ åˆ¸æˆ–å¥—é¤ä»·æ ¼ï¼›æ˜ç¡®è¯´æ˜ä»˜æ¬¾æµç¨‹å’Œåˆ†æœŸé€‰é¡¹ï¼›å¼ºè°ƒæˆåŠŸæ¡ˆä¾‹å’Œå®¢æˆ·å¥½è¯„ï¼Œå¢å¼ºä¿¡å¿ƒã€‚
è¥é”€è§¦è¾¾å»ºè®®ï¼š å»ºè®®è¿‘æœŸé‡ç‚¹è·Ÿè¿›ï¼Œé€‚æ—¶å‘é€ä¿ƒé”€æ´»åŠ¨ä¿¡æ¯ã€‚

ã€5ã€åˆ°åº—å‰å‡†å¤‡å»ºè®®ã€‘
- æ¨èåˆé€‚çš„åŒ»ç”Ÿ/ç¾å®¹å¸ˆï¼Œå¹¶ç®€è¦è¯´æ˜æ¨èä¾æ®ï¼ˆå¦‚å®¡ç¾åå¥½ã€é£æ ¼åŒ¹é…ã€ç”¨æˆ·è¡¨è¾¾ä¿¡ä»»ç­‰ï¼‰ï¼›
- æå‡ºä¸ªæ€§åŒ–æ²Ÿé€šå»ºè®®ï¼šé¦–æ¬¡åˆ°åº—æ—¶çš„é‡ç‚¹ä»‹ç»å†…å®¹ã€å¦‚ä½•å¿«é€Ÿå»ºç«‹ä¿¡ä»»ã€æ˜¯å¦é€‚åˆç«‹å³åˆ¶å®šæ–¹æ¡ˆï¼›
- åˆ¤æ–­æ˜¯å¦å»ºè®®å®¢æˆ·é‚€çº¦å®¶å±/æœ‹å‹åŒè¡Œï¼Œè¾…åŠ©å†³ç­–ã€‚
eg.
æ¨èåŒ»ç”Ÿ/ç¾å®¹å¸ˆï¼š æ¨èåˆ˜ä¸»ä»»ï¼Œå› å®¢æˆ·åå¥½è‡ªç„¶éŸ©å¼é£æ ¼ï¼Œä¸”åœ¨å¯¹è¯ä¸­å¤šæ¬¡æåŠå¯¹åˆ˜ä¸»ä»»çš„ä¿¡ä»»ã€‚
æ²Ÿé€šå»ºè®®ï¼š é¦–æ¬¡åˆ°åº—é‡ç‚¹ä»‹ç»æ‰‹æœ¯å®‰å…¨å’Œæ¢å¤æµç¨‹ï¼Œè€å¿ƒè§£ç­”å®¢æˆ·ç–‘è™‘ï¼Œå»ºç«‹ä¿¡ä»»æ„Ÿã€‚å»ºè®®é¿å…ä¸€æ¬¡æ€§æ¨ä»‹è¿‡å¤šé¡¹ç›®ï¼Œå¾ªåºæ¸è¿›ã€‚
é™ªåŒå»ºè®®ï¼š å»ºè®®é‚€è¯·å®¶å±æˆ–æœ‹å‹åŒè¡Œï¼Œæœ‰åŠ©äºç¼“è§£å®¢æˆ·ç´§å¼ æƒ…ç»ªï¼Œä¿ƒè¿›å†³ç­–ã€‚

ã€6ã€åŒ»ç–—é£é™©ä¸ç‰¹åˆ«æ³¨æ„äº‹é¡¹ã€‘ï¼ˆæ²¡æœ‰çš„å†™æš‚æ— ï¼‰
- æ˜ç¡®æ˜¯å¦å­˜åœ¨éœ€é¢å¤–å…³æ³¨çš„èº«ä½“æƒ…å†µï¼ˆå¦‚ä½“è´¨ç‰¹æ®Šã€è¿‡æ•ã€æœ¯åæ‹…å¿§ç­‰ï¼‰ï¼›
- é’ˆå¯¹ç”¨æˆ·å¯¹ç—›æ„Ÿã€ä»·æ ¼ã€æ¢å¤æœŸç­‰çš„å…³æ³¨ï¼Œæå‡ºé¢„è­¦é¡¹ä¸ç¼“è§£å»ºè®®ï¼›
- åˆ¤æ–­å®¢æˆ·æ˜¯å¦å­˜åœ¨â€œå†²åŠ¨æ¶ˆè´¹â€å€¾å‘ï¼Œå¹¶æä¾›å¹²é¢„å»ºè®®ï¼ˆå¦‚å…ˆä½“éªŒã€æœ¯å‰æ•™è‚²ç­‰ï¼‰ï¼›
- æå‡ºæœ¯åæŠ¤ç†é‡ç‚¹æç¤ºï¼Œä¾›åŒ»ç”Ÿå’ŒæŠ¤ç†å›¢é˜Ÿå‚è€ƒã€‚
egã€‚
èº«ä½“æƒ…å†µå…³æ³¨ï¼š å®¢æˆ·æ— æ˜æ˜¾è¿‡æ•å²ï¼Œä½†æåŠå¯¹æ¢å¤æœŸè‚¿èƒ€è¾ƒä¸ºæ‹…å¿§ï¼Œéœ€é‡ç‚¹å…³æ³¨ã€‚
å…³æ³¨ç‚¹åŠç¼“è§£å»ºè®®ï¼š é’ˆå¯¹ç—›æ„ŸåŠä»·æ ¼æ•æ„Ÿï¼Œå»ºè®®æä¾›æœ¯å‰ç—›æ„Ÿç®¡ç†æ–¹æ¡ˆåŠåˆ†æœŸä»˜æ¬¾é€‰é¡¹ã€‚
å†²åŠ¨æ¶ˆè´¹åˆ¤æ–­ï¼š å®¢æˆ·è¡¨è¾¾çŠ¹è±«ï¼Œå»ºè®®å…ˆä½“éªŒé¡¹ç›®ï¼Œé¿å…å†²åŠ¨å†³ç­–ã€‚
æœ¯åæŠ¤ç†æç¤ºï¼š å¼ºè°ƒæœ¯åæŠ¤ç†æµç¨‹å’Œæ³¨æ„äº‹é¡¹ï¼Œå»ºè®®å®šæœŸå¤è¯Šä¸æŠ¤ç†å›¢é˜Ÿè·Ÿè¿›ã€‚

ã€7ã€æœåŠ¡ä¸è¥é”€ç­–ç•¥æ¨èã€‘
- æ ¹æ®ç”¨æˆ·ç‰¹å¾ä¸æ„å›¾ï¼Œæ¨èé€‚åˆçš„é¡¹ç›®ç»„åˆï¼Œå¹¶ç®€è¦è¯´æ˜ç†ç”±ï¼›
- åˆ¤æ–­æ˜¯å¦é€‚é…å½“å‰é—¨åº—çš„è¥é”€æ´»åŠ¨ï¼ˆå¦‚æ–°äººç«‹å‡ã€ä½“éªŒå¡ç­‰ï¼‰ï¼›
- æå‡ºä¸ªæ€§åŒ–è¯æœ¯å…³é”®è¯å»ºè®®ï¼ˆå¦‚â€œä¸“ä¸šè®¤è¯â€â€œæ¢å¤å‘¨æœŸä¿éšœâ€â€œéšç§ä¿æŠ¤â€ç­‰ï¼‰ï¼Œä¾›é¡¾é—®æ¥å¾…æ—¶ä½¿ç”¨ï¼›
- åˆ¤æ–­æ˜¯å¦é€‚åˆâ€œå…ˆä½“éªŒåè½¬åŒ–â€ç­–ç•¥ï¼Œå¹¶è¯´æ˜åŸå› ã€‚
---------------------------------------------------------------------------------------------------------

"""
    return [{"role": "system", "content": system_msg}] + state["messages"]
def prompt_user_chunk_summary(state: AgentState) -> List[AnyMessage]:
    system_prompt = f"""
ä½ æ˜¯ä¸€åèµ„æ·±åŒ»ç¾é¡¾é—®ï¼Œä»¥ä¸‹æ˜¯AIå®¢æœä¸ç”¨æˆ·çš„å®Œæ•´å¤šè½®æ²Ÿé€šå†…å®¹ï¼š{state["messages"]}

è¯·ä½ åŸºäºè¯¥å¯¹è¯å†…å®¹ï¼Œæ’°å†™ä¸€ä»½ç»“æ„åŒ–ã€ä¸“ä¸šã€å®ç”¨çš„åŒ»ç¾å®¢æˆ·ä¿¡æ¯æ´å¯Ÿä¸æ¥å¾…å‡†å¤‡ã€‚è¯¥æŠ¥å‘Šå°†ç”¨äºé—¨åº—é¡¾é—®æ¥å¾…å‰ä¼šè®®æˆ–å®¢æˆ·ç®¡ç†ç³»ç»Ÿå½•å…¥ï¼Œéœ€çªå‡ºç”¨æˆ·ç‰¹å¾ã€æ²Ÿé€šé£æ ¼ã€é¡¹ç›®æ„å›¾ã€æˆäº¤æ½œåŠ›ä¸æ½œåœ¨é˜»åŠ›ç­‰å…³é”®ä¿¡æ¯ï¼Œå…·å¤‡æ˜ç¡®çš„åˆ¤æ–­ç»“è®ºä¸æ‰§è¡Œå»ºè®®ä»·å€¼ã€‚
ğŸ“Œ æ—¶é—´çº¿åˆ†æè¦æ±‚ï¼š(å¦‚æœæœ‰å¯¹è¯æ—¶é—´æˆ–è€…ç”¨æˆ·æåˆ°çš„æ—¶é—´ï¼‰
- è¯·ç»“åˆå¯¹è¯æ—¶é—´ï¼Œè¯„ä¼°ä¿¡æ¯çš„â€œæ–°é²œåº¦â€ï¼Œå¯¹ç”¨æˆ·æœ€è¿‘è¡¨è¾¾çš„ä¿¡æ¯ç»™äºˆæ›´é«˜æƒé‡ï¼›
- è‹¥å®¢æˆ·é•¿æ—¶é—´æœªå›å¤ã€è¡¨è¾¾çŠ¹è±«ã€ä¿¡æ¯ä¸­æ–­ï¼Œè¯·ç‰¹åˆ«æ ‡æ³¨â€œæ½œåœ¨æµå¤±é¢„è­¦â€ï¼›
- è‹¥å¯¹æ—¶é—´ç‚¹è¡¨è¾¾ä¸æ˜ï¼Œè¯·ä½¿ç”¨æ‹¬å·æ ‡æ³¨â€œéœ€ç¡®è®¤â€ã€‚

ğŸ“Œ è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
- æŠ¥å‘Šè¯­è¨€é£æ ¼éœ€æ­£å¼ã€ä¸“ä¸šï¼›
- å„æ¨¡å—å†…å®¹å®Œæ•´ï¼Œå¦‚æ— ç›¸å…³ä¿¡æ¯è¯·æ ‡æ³¨â€œæš‚æœªæåŠâ€æˆ–â€œæš‚æ— æ³•åˆ¤æ–­â€ï¼Œä¸å¾—é—æ¼æ¨¡å—ï¼›
- è¯·ç¡®ä¿é€»è¾‘æ¸…æ™°ã€è¯­ä¹‰å‡†ç¡®ï¼Œé¿å…ç©ºæ³›è¡¨è¾¾ï¼Œä¾¿äºCRMç³»ç»Ÿå½’æ¡£åŠé—¨åº—å›¢é˜Ÿè½åœ°æ‰§è¡Œã€‚
- æœ¬æ¬¡è¾“å‡ºæœ‰ä¸”åªéœ€è¦"åŒ»ç¾å®¢æˆ·ä¿¡æ¯æ´å¯Ÿä¸æ¥å¾…å‡†å¤‡"éƒ¨åˆ†ï¼Œè¯·å‹¿å°†å…¶ä»–å†…å®¹æ”¾è¿›æ¥ï¼Œä¸”ä¸è¦æ”¾é‡å¤å†…å®¹ã€‚
---------------------------------------------------------------------------------------------------------

äºŒã€åŒ»ç¾å®¢æˆ·ä¿¡æ¯æ´å¯Ÿä¸æ¥å¾…å‡†å¤‡æŠ¥å‘Š
ã€1ã€‘ç”¨æˆ·æƒ…å†µä¸€å¥è¯æ¦‚æ‹¬ï¼ˆå¦‚èƒ½æå–ï¼‰
- ç”¨ä¸€å¥è¯æç‚¼ç”¨æˆ·æ ¸å¿ƒç”»åƒï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šåŸå¸‚ã€æ€§åˆ«ã€ä¸»è¦æ„å‘é¡¹ç›®ã€æ”¯ä»˜çŠ¶æ€ã€æ—¶é—´å®‰æ’ã€ç¾å­¦åå¥½ã€åŒ»ç”Ÿåå¥½ã€ç¤¾äº¤è¡Œä¸ºã€æœ¯åæ‹…å¿§ç­‰ï¼›
- ç¤ºä¾‹ï¼š**â€œé‡åº†å¥³æ€§æ¨å¥³å£«ï¼Œè®¡åˆ’æš‘æœŸåšåŒçœ¼çš®+éš†é¼»ï¼Œåå¥½éŸ©å¼è‡ªç„¶é£æ ¼ï¼Œå·²æ”¯ä»˜å®šé‡‘ï¼Œå€¾å‘åˆ˜ä¸»ä»»ï¼Œæ²Ÿé€šè°¨æ…ï¼Œå…·KOCæ½œåŠ›ã€‚â€**

---

ã€2ã€‘èº«ä»½æ ‡ç­¾ä¸çŠ¶æ€åˆ¤æ–­
- åˆå§‹èº«ä»½ï¼šæ–°å®¢æˆ· / è€å®¢æˆ· / VIPå®¢æˆ· / æš‚æ— æ³•åˆ¤æ–­
- å½“å‰çŠ¶æ€ï¼šæ½œåœ¨å®¢æˆ· / å¼ºæ„å‘å®¢æˆ·ï¼ˆå·²é¢„çº¦ï¼‰/ å·²è½¬åŒ–å®¢æˆ·ï¼ˆå·²æ”¯ä»˜ï¼‰/ æš‚æ— æ³•åˆ¤æ–­
- æ¨èæ ‡ç­¾ï¼šå¦‚ã€Œæ´»è·ƒé«˜æ„æ„¿ã€ã€Œä»·æ ¼æ•æ„Ÿå‹ã€ã€Œæ¢å¤å…³æ³¨å‹ã€ã€Œç¤¾äº¤å‹ä¼ æ’­è€…ã€ã€Œè§‚æœ›å‹å®¢æˆ·ã€ç­‰

---

ã€3ã€‘åŸºæœ¬ç”¨æˆ·ä¿¡æ¯
- å§“å / æ€§åˆ« / å¹´é¾„ï¼ˆå¦‚æœ‰æåŠï¼‰ï¼š
- æ‰€åœ¨åŸå¸‚ä¸åˆ°åº—ä¾¿åˆ©æ€§ï¼ˆå¦‚æ˜¯å¦è·¨åŸï¼‰ï¼š
- è”ç³»æ–¹å¼ / æ˜µç§°ï¼ˆå¦‚æœ‰ï¼‰ï¼š

---

ã€4ã€‘å¤–è²Œç›®æ ‡ä¸å¿ƒç†åŠ¨æœº
- å…³æ³¨çš„éƒ¨ä½æˆ–å¤–è²Œé—®é¢˜ï¼š
- ç¾å­¦åå¥½ï¼ˆå¦‚éŸ©å¼ã€è‡ªç„¶é£ã€æ¬§ç¾ç­‰ï¼‰ï¼š
- æƒ…ç»ªåŠ¨æœºï¼ˆå¦‚æå‡æ°”è´¨ã€å©šç¤¼è®¡åˆ’ã€è‡ªæˆ‘è®¤å¯ç­‰ï¼‰ï¼š
- å¯¹æ•´å½¢çš„æ¥å—ç¨‹åº¦ä¸å¿ƒç†å‡†å¤‡åº¦ï¼š

---

ã€5ã€‘è¿‡å¾€å†å²ä¸æœåŠ¡è®°å½•
- æ›¾æ¥å—çš„é¡¹ç›®åŠæ¢å¤åé¦ˆï¼š
- æ˜¯å¦æœ‰ä¸æ»¡ç»å†æˆ–ä¿®å¤é¡¹ç›®ç»å†ï¼š
- ç‰¹æ®Šä½“è´¨æˆ–ç¦å¿Œæƒ…å†µï¼ˆå¦‚éº»è¯è¿‡æ•ã€ç˜¢ç—•ä½“è´¨ï¼‰ï¼š
- åå¥½åŒ»ç”Ÿ / æŠ•è¯‰è®°å½•ï¼ˆå¦‚æœ‰ï¼‰ï¼š

---

ã€6ã€‘æ„å‘é¡¹ç›®ä¸å¯¹è¯æ„å›¾
- æ˜ç¡®è¡¨è¾¾çš„é¡¹ç›®æ„å‘ï¼š
- å½“å‰æœ€å…³æ³¨éƒ¨ä½åŠè¡¨è¾¾åŸå› ï¼š
- å¯¹ä»·æ ¼ã€æŠ˜æ‰£ã€ä»˜æ¬¾æ–¹å¼çš„å…³æ³¨ç¨‹åº¦ï¼š
- é£é™©å…³æ³¨ç‚¹ï¼ˆå¦‚æœ¯åè‚¿èƒ€ã€éº»é†‰æ–¹å¼ç­‰ï¼‰ï¼š
- é¢„çº¦ / æ”¯ä»˜ / ä¸‹å•çŠ¶æ€åˆ¤æ–­ï¼š

---

ã€7ã€‘æƒ…ç»ªä¸æ²Ÿé€šé£æ ¼åˆ†æ
- å½“å‰æƒ…ç»ªçŠ¶æ€ï¼ˆå¦‚ç„¦è™‘ / æœŸå¾… / è§‚æœ›ï¼‰ï¼š
- æ²Ÿé€šé£æ ¼ï¼ˆå¦‚ç†æ€§å‹ / æƒ…ç»ªå‹ / å†³ç­–ç¼“æ…¢å‹ï¼‰ï¼š
- å†³ç­–ä¸»å¯¼è€…ï¼ˆæœ¬äºº / å®¶å± / æœ‹å‹ï¼‰ï¼š
- ä¸AI/å®¢æœäº’åŠ¨ä¸­çš„æƒ…ç»ªå€¾å‘ï¼š

---

ã€8ã€‘ç¤¾äº¤æ•°æ®ä¸æ½œåœ¨å½±å“åŠ›
- æ˜¯å¦æ´»è·ƒäºç¤¾äº¤å¹³å° / æ™’å›¾å€¾å‘ï¼š
- æ˜¯å¦å…·å¤‡KOCä¼ æ’­æ½œåŠ›ï¼š
- æ˜¯å¦è¡¨è¾¾è¿‡é‚€çº¦æœ‹å‹æˆ–å‚è€ƒä»–äººå»ºè®®çš„æ„æ„¿ï¼š

---

ã€9ã€‘ä»–äººç»å†å¯¹ç”¨æˆ·æ€åº¦çš„å½±å“
- æ˜ç¡®è¯´æ˜æœ‹å‹æˆ–ç†Ÿäººç»å†å¯¹ç”¨æˆ·å½±å“ï¼ˆæ­£å‘ / è´Ÿå‘ / åŠ å¼ºå…´è¶£ / åŠ æ·±é¡¾è™‘ï¼‰ï¼›
- ç¤ºä¾‹ï¼š 
  - â€œæœ‹å‹æœ¯åè‚¿èƒ€ä¸¥é‡ â†’ å¼ºåŒ–æ¢å¤æ‹…å¿§â€
  - â€œé—ºèœœéš†é¼»æ•ˆæœå¥½ â†’ æå‡ç»„åˆæ„æ„¿â€

---

ã€10ã€‘ç”¨æˆ·æ—¶é—´çº¿å…³é”®äº‹ä»¶
- æ˜ç¡®è¡¨è¾¾çš„å…³é”®æ—¶é—´èŠ‚ç‚¹ï¼ˆå¦‚â€œå·²é¢„çº¦7æœˆåˆâ€ï¼Œâ€œè®¡åˆ’å›½åº†æ‰‹æœ¯â€ç­‰ï¼‰ï¼š
- å«ç³Šè¡¨è¾¾è¯·æ ‡æ³¨â€œï¼ˆéœ€ç¡®è®¤ï¼‰â€ï¼š

---

ã€11ã€‘æ½œåœ¨é˜»åŠ›ä¸åº”å¯¹å»ºè®®
- æ˜ç¡®å®¢æˆ·å¯èƒ½å­˜åœ¨çš„æˆäº¤é˜»åŠ›ï¼ˆå¦‚æ—¶é—´å†²çªã€ä»·æ ¼é¡¾è™‘ã€æœ¯åç„¦è™‘ç­‰ï¼‰ï¼›
- é’ˆå¯¹æ€§æœåŠ¡å»ºè®®ï¼ˆå¦‚ï¼šâ€œæä¾›æœ¯åæ¡ˆä¾‹å›¾å†Œç¼“è§£é¡¾è™‘â€ï¼Œâ€œå»ºè®®å…ˆå®‰æ’ä½“éªŒé¡¹ç›®â€ï¼‰

---------------------------------------------------------------------------------------------------------

"""
    return [{"role": "system", "content": system_prompt}] + state["messages"]




def prompt_ai_dialog_style(state: AgentState) -> List[AnyMessage]:
    system_msg = f"""
ä½ æ˜¯ä¸€åè¯­è¨€é£æ ¼åˆ†æä¸“å®¶ï¼Œä»¥ä¸‹æ˜¯åŒ»ç¾AIå®¢æœä¸ç”¨æˆ·çš„å®Œæ•´å¤šè½®æ²Ÿé€šå†…å®¹æ‘˜è¦ï¼š{state["messages"]}

è¯·ä½ åŸºäºè¯¥å¯¹è¯å†…å®¹ï¼Œæ’°å†™ä¸€ä»½ç»“æ„åŒ–ã€ä¸“ä¸šã€å…·åŸ¹è®­ä»·å€¼çš„ã€ŠAIå®¢æœå¯¹è¯é£æ ¼åˆ†ææŠ¥å‘Šã€‹ã€‚è¯¥æŠ¥å‘Šå°†ç”¨äºäººå·¥å®¢æœæ¥å¾…å‰çš„æ²Ÿé€šé£æ ¼å¯¹é½å’ŒæœåŠ¡ä¸€è‡´æ€§åŸ¹è®­ï¼Œéœ€çªå‡ºAIå®¢æœåœ¨è¯­æ°”è¡¨è¾¾ã€ç­–ç•¥è¿ç”¨å’ŒèŠ‚å¥æŠŠæ§æ–¹é¢çš„å…·ä½“è¡¨ç°ï¼Œå¹¶ç»“åˆåŸè¯æœ¯ä¸¾ä¾‹æ”¯æ’‘åˆ¤æ–­ã€‚
ğŸ“Œ è¾“å‡ºè¦æ±‚ï¼š
- æŠ¥å‘Šè¯­è¨€ç»Ÿä¸€é‡‡ç”¨æ­£å¼ã€ä¸“ä¸šé£æ ¼ï¼›
- æ‰€æœ‰ç»´åº¦å¿…é¡»å¡«å†™ï¼Œæ— æ³•åˆ¤æ–­è¯·å†™â€œæš‚æ— æ³•æç‚¼â€ï¼Œä¸å¯ç•™ç©ºï¼›
- æŠ¥å‘Šå°†ç”¨äºå›¢é˜Ÿå®¢æœé£æ ¼ç»Ÿä¸€ã€AIè¯æœ¯è®­ç»ƒä¸äººå·¥æ¥å¾…åŸ¹è®­ææ–™å½’æ¡£ã€‚
- æœ¬æ¬¡è¾“å‡ºæœ‰ä¸”åªéœ€è¦"AIå®¢æœå¯¹è¯é£æ ¼åˆ†ææŠ¥å‘Š"éƒ¨åˆ†ï¼Œè¯·å‹¿å°†å…¶ä»–å†…å®¹æ”¾è¿›æ¥ï¼Œä¸”ä¸è¦æ”¾é‡å¤å†…å®¹ã€‚
---------------------------------------------------------------------------------------------------------
ä¸‰ã€AIå®¢æœå¯¹è¯é£æ ¼åˆ†ææŠ¥å‘Š

ã€1ã€‘è¯­æ°”ä¸è¯­è¨€é£æ ¼åˆ†æ
- æ€»ç»“AIå®¢æœæ•´ä½“çš„è¯­æ°”ç‰¹å¾ï¼Œå¦‚â€œæ¸©å’Œäº²åˆ‡â€â€œåŒç†å¿ƒå¼ºâ€â€œç®€æ´ä¸“ä¸šâ€â€œé¿å…æ–½å‹â€ç­‰ï¼›
- è¯·å¼•ç”¨1-2å¥å…·ä»£è¡¨æ€§çš„å®¢æœè¯æœ¯ä½œä¸ºæ”¯æŒç¤ºä¾‹ï¼›
- å¦‚å¯¹è¯å†…å®¹ä¸è¶³ä»¥åˆ¤æ–­ï¼Œè¯·ç»Ÿä¸€å¡«å†™â€œæš‚æ— æ³•æç‚¼â€ã€‚

**ç¤ºä¾‹æ ¼å¼ï¼š**
- é£æ ¼ç‰¹ç‚¹ï¼šäº²åˆ‡è€å¿ƒã€é¿å…æ–½å‹
- å…¸å‹è¯æœ¯ï¼šâ€œæ²¡å…³ç³»ï¼Œæˆ‘ä»€ä¹ˆæ—¶å€™éƒ½å¯ä»¥ç­‰æ‚¨â€ã€â€œæ‚¨å¯ä»¥æ…¢æ…¢è€ƒè™‘ï¼Œä¸ç€æ€¥å†³å®šâ€

---

ã€2ã€‘ä¸»è¦æ²Ÿé€šç­–ç•¥åˆ†æ
- æç‚¼AIå®¢æœåœ¨æ­¤æ¬¡å¯¹è¯ä¸­é‡‡ç”¨çš„æ ¸å¿ƒç­–ç•¥ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
  - å¼•å¯¼å¼æé—®ï¼ˆå¾ªåºæ¸è¿›å¼•å‡ºéœ€æ±‚ï¼‰
  - ä¿¡æ¯ç¡®è®¤ï¼ˆåå¤ç¡®è®¤å®¢æˆ·è¡¨è¾¾ï¼‰
  - æƒ…ç»ªå›åº”ï¼ˆå¯Ÿè§‰ç„¦è™‘å¹¶ä¸»åŠ¨å®‰æŠšï¼‰
  - é¡¹ç›®å»ºè®®ï¼ˆç»“åˆæ„å›¾æ¨èä¸ªæ€§åŒ–æ–¹æ¡ˆï¼‰
- æ¯ç§ç­–ç•¥å»ºè®®é™„å¸¦ä¸€å¥å®é™…è¯æœ¯ä½œä¸ºä¾‹è¯ï¼›
- è‹¥æ— æ³•è¯†åˆ«å…·ä½“ç­–ç•¥ï¼Œè¯·å¡«å†™â€œæš‚æ— æ³•æç‚¼â€ã€‚

**ç¤ºä¾‹æ ¼å¼ï¼š**
- ç­–ç•¥ç±»å‹ï¼šä¿¡æ¯ç¡®è®¤ + æƒ…ç»ªå›åº”
- ç¤ºä¾‹è¯æœ¯ï¼šâ€œæ‚¨æ˜¯è€ƒè™‘æš‘å‡åšé¡¹ç›®å¯¹å§ï¼Ÿâ€ã€â€œå¬èµ·æ¥æ‚¨å¯¹æ¢å¤æœŸæœ‰ç‚¹é¡¾è™‘ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨è¯¦ç»†ä»‹ç»æŠ¤ç†æµç¨‹ã€‚â€

---

ã€3ã€‘å¯¹è¯èŠ‚å¥ä¸äº’åŠ¨æ¨¡å¼åˆ†æ
- åˆ†æAIå®¢æœåœ¨äº¤æµä¸­çš„å“åº”èŠ‚å¥ä¸äº’åŠ¨é€»è¾‘ï¼Œåˆ¤æ–­æ˜¯å¦å…·å¤‡å¦‚ä¸‹ç‰¹å¾ï¼š
  - å“åº”è¿…é€Ÿ / èŠ‚å¥è‡ªç„¶
  - è¡¨è¾¾ç»“æ„æ¸…æ™° / åˆ†å±‚æ¨è¿›
  - é•¿ä¿¡æ¯è¡¨è¾¾åç»™äºˆåœé¡¿ç©ºé—´
- è¯·å¼•ç”¨1æ®µå…·æœ‰ä»£è¡¨æ€§çš„äº’åŠ¨ç‰‡æ®µæ”¯æ’‘åˆ†æï¼›
- å¦‚èŠ‚å¥ä¿¡æ¯æ¨¡ç³Šï¼Œè¯·å¡«å†™â€œæš‚æ— æ³•æç‚¼â€ã€‚

**ç¤ºä¾‹æ ¼å¼ï¼š**
- èŠ‚å¥ç‰¹ç‚¹ï¼šå“åº”è¿…é€Ÿã€è¡¨è¾¾åˆ†å±‚æ¸…æ™°
- å‚è€ƒç‰‡æ®µï¼šâ€œæ‚¨åˆšæåˆ°é¼»ç»¼åˆï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æ‹†è§£ä¸€ä¸‹å¸¸è§çš„ä¸‰ä¸ªæœ¯å¼...â€ â†’ â€œå¦å¤–ï¼Œæ ¹æ®æ‚¨è¯´çš„â€˜åè‡ªç„¶â€™é£æ ¼ï¼Œæˆ‘ä»¬åŒ»ç”Ÿè¿™è¾¹ä¹Ÿæœ‰...â€

---------------------------------------------------------------------------------------------------------

"""
    return [{"role": "system", "content": system_msg}] + state["messages"]


user_summary_agent = create_react_agent(
    model=llm,
    tools=[],
    name="user_chunk_summary_agent",
    state_schema=UserSummaryAgentState,
    response_format=UserChunkSummaryResponse,
    prompt=prompt_user_chunk_summary,
)

ai_style_agent = create_react_agent(
    model=llm,
    tools=[],
    name="ai_dialog_style_agent",
    state_schema=AiStyleAgentState,
    response_format=AiDialogStyleResponse,
    prompt=prompt_ai_dialog_style,
)

recommendation_agent = create_react_agent(
    model=llm,
    tools=[],
    name="recommendation_agent",
    state_schema=RecommendationAgentState,
    response_format=RecommendationResponse,
    prompt=prompt_recommendation,
)

industry_name = "åŒ»ç¾"
async def run_agent_node(agent, state: AgentState, config: RunnableConfig, role_desc="ä¸“å®¶", messages_override=None):
    current_conversation_messages = state.get("messages", [])
    if not current_conversation_messages:
        system_msg = [{"role": "system", "content": f"ä½ æ˜¯ä¸€ä¸ª{industry_name}é¢†åŸŸ{role_desc}ã€‚"}]
        current_conversation_messages = system_msg

    try:
        agent_response = await asyncio.to_thread(
            agent.invoke,
            {"messages": current_conversation_messages},
            config
        )
        return {
            "structured_response": agent_response.get("structured_response"),
            "error_message": None,
            "messages": agent_response.get("messages", []),
        }
    except Exception as e:
        return {"error_message": str(e)}
#
# # å„èŠ‚ç‚¹å¼‚æ­¥å‡½æ•°
# async def recommendation_node(state: RecommendationAgentState, config):
#     return await run_agent_node(recommendation_agent, state, config, role_desc="å¯¹è¡Œä¸šéå¸¸äº†è§£çš„ä¸“å®¶ï¼Œå¯ç»™é—¨åº—å»ºè®®")
# async def user_summary_node(state: UserSummaryAgentState, config):
#     return await run_agent_node(user_summary_agent, state, config, role_desc="æœ‰åå¹´è¡Œä¸šç»éªŒçš„ä¸“å®¶")
#
# async def ai_style_node(state: AiStyleAgentState, config):
#     return await run_agent_node(ai_style_agent, state, config, role_desc="æ•é”æ´å¯Ÿå®¢æˆ·å–œå¥½é£æ ¼çš„ä¸“å®¶")
#
#
# from typing import List, Dict, Any
#
#
# async def combine_reports_node(state: UserAnalysisAgentState) -> UserAnalysisAgentState:
#     messages = state.get("messages", [])
#     last_three = messages[-3:] if len(messages) >= 3 else messages
#     contents = [msg.content if hasattr(msg, "content") else str(msg) for msg in last_three]
#     combined_text = "\n\n-------\n\n".join(contents)
#
#     # å†™å…¥åˆ° structured_response ä¸­ï¼Œä¾¿äº dev æ˜¾ç¤º
#     state["structured_response"] = combined_text
#     return state
#
# user_analysis_graph = (
#     StateGraph(
#         UserSummaryAgentState,
#         input=ChatReplyAgentStateInput,
#         config_schema=RunnableConfig
#     )
#     .add_node("recommendation", recommendation_node)
#     .add_node("user_summary_node", user_summary_node)
#     .add_node("ai_style_node", ai_style_node)
#     .add_node("combine_reports_node", combine_reports_node)  # åŠ å…¥åˆå¹¶èŠ‚ç‚¹
#     .add_edge(START, "recommendation")
#     .add_edge("recommendation", "user_summary_node")
#     .add_edge("user_summary_node", "ai_style_node")
#     .add_edge("ai_style_node", "combine_reports_node")       # æŠŠåˆå¹¶èŠ‚ç‚¹æ”¾åˆ°æœ€å
#     .add_edge("combine_reports_node", END)
#     .compile()
# )

async def parallel_analysis_node(state: AgentState, config: RunnableConfig) -> Dict[str, Any]:
    # ä¸‰ä¸ª Agent å¹¶è¡Œè¿è¡Œ
    results = await asyncio.gather(
        run_agent_node(recommendation_agent, state, config, role_desc="å¯¹è¡Œä¸šéå¸¸äº†è§£çš„ä¸“å®¶ï¼Œå¯ç»™é—¨åº—å»ºè®®"),
        run_agent_node(user_summary_agent, state, config, role_desc="æœ‰åå¹´è¡Œä¸šç»éªŒçš„ä¸“å®¶"),
        run_agent_node(ai_style_agent, state, config, role_desc="æ•é”æ´å¯Ÿå®¢æˆ·å–œå¥½é£æ ¼çš„ä¸“å®¶"),
    )

    rec_result, summary_result, style_result = results

    def get_last_message_text(res):
        msgs = res.get("messages", [])
        if msgs and hasattr(msgs[-1], "content"):
            return msgs[-1].content
        elif msgs and isinstance(msgs[-1], dict) and "content" in msgs[-1]:
            return msgs[-1]["content"]
        return ""

    # å–æ¯ä¸ª agent æœ€åä¸€æ¡æ¶ˆæ¯çš„æ–‡æœ¬ï¼Œæ‹¼æˆå­—ç¬¦ä¸²
    combined_text = (
        "\n\n=== åŒ»ç¾å®¢æˆ·é£é™©é¢„è­¦ä¸æœåŠ¡å»ºè®® ===\n" + get_last_message_text(rec_result) +
        "\n\n=== åŒ»ç¾å®¢æˆ·ä¿¡æ¯æ´å¯Ÿä¸æ¥å¾…å‡†å¤‡æŠ¥å‘Š ===\n" + get_last_message_text(summary_result) +
        "\n\n=== AIå®¢æœå¯¹è¯é£æ ¼åˆ†ææŠ¥å‘Š ===\n" + get_last_message_text(style_result)
    )
    return {
        "structured_response": combined_text,  # ğŸ”¥ ç»“æ„åŒ–è¾“å‡º
        "error_message": None,
        "messages": []
    }

user_analysis_graph = (
    StateGraph(
        UserSummaryAgentState,  # å¯ä»¥ç»§ç»­ç”¨è¿™ä¸ª Stateï¼ŒAgentState ç»“æ„ç›¸åŒå³å¯
        input=ChatReplyAgentStateInput,
        config_schema=RunnableConfig
    )
    .add_node("parallel_analysis_node", parallel_analysis_node)     # æ–°å¹¶è¡ŒèŠ‚ç‚¹
    .add_edge(START, "parallel_analysis_node")                      # ä» START åˆ°å¹¶è¡ŒèŠ‚ç‚¹
    .add_edge("parallel_analysis_node", END)                          # æ±‡æ€»åç»“æŸ
    .compile()
)
